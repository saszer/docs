---
title: 'Authentication'
description: 'OAuth and API key authentication for MCP server'
---

# MCP Authentication

AI2Fin MCP Server supports two authentication methods depending on your use case.

## Authentication Methods

<Tabs>
  <Tab title="OAuth (JWT)">
    For ChatGPT Apps SDK and OAuth-based integrations
  </Tab>
  
  <Tab title="API Key">
    For MCP Inspector, custom integrations, and testing
  </Tab>
</Tabs>

---

## OAuth Authentication

Used by the **`/mcp`** endpoint for ChatGPT Apps SDK integration.

### How It Works

1. User authenticates via OAuth (Zitadel)
2. OAuth provider issues JWT token
3. JWT token included in `Authorization: Bearer <token>` header
4. Server validates token and extracts `userId`
5. All operations scoped to that `userId`

### Request Format

```http
POST /mcp
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {}
}
```

### Rate Limiting

- **Per-user limit:** 200 requests per 15 minutes
- **Burst size:** 30 requests
- **Key:** `mcp_user_{userId}`

### Use Cases

- ChatGPT Apps SDK integration
- OAuth-based custom integrations
- Full write access (with confirmation for destructive operations)

---

## API Key Authentication

Used by the **`/mcp/inspector`** endpoint for MCP Inspector and custom integrations.

### How It Works

1. Admin generates API key via `/api/admin/api-keys` endpoint
2. API key stored as SHA-256 hash (never plaintext)
3. API key included in `X-API-Key: <key>` header
4. Server validates key hash and extracts `userId` from key record
5. All operations scoped to that `userId`

### Request Format

```http
POST /mcp/inspector
X-API-Key: mcp_a1b2c3d4e5f6...
Content-Type: application/json

{
  "jsonrpc": "2.0",
  "id": 1,
  "method": "initialize",
  "params": {}
}
```

### API Key Format

- **Prefix:** `mcp_`
- **Length:** 64 hex characters
- **Example:** `mcp_a1b2c3d4e5f6789012345678901234567890abcdef1234567890abcdef123456`

### Generating API Keys

```bash
POST /api/admin/api-keys
Authorization: Bearer <admin_token>
Content-Type: application/json

{
  "name": "MCP Inspector - Production",
  "scopes": ["mcp:read", "mcp:tools:list"],
  "expiresInDays": 90
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "id": "key_123",
    "name": "MCP Inspector - Production",
    "key": "mcp_a1b2c3d4...",  // ⚠️ Only shown once!
    "scopes": ["mcp:read", "mcp:tools:list"],
    "expiresAt": "2024-04-01T00:00:00Z",
    "createdAt": "2024-01-01T00:00:00Z"
  }
}
```

<Warning>
**Save the `key` value immediately** - it's only shown once during creation. If lost, you must revoke and create a new key.
</Warning>

### API Key Scopes

- **`mcp:read`** - Read-only access to all MCP operations
- **`mcp:tools:list`** - List available tools
- **`mcp:tools:call`** - Execute tools (read-only)
- **`mcp:resources:read`** - Read resources
- **`mcp:full`** - Full access (read + write)
- **`*` (Admin)** - Admin access (all operations)

### Rate Limiting

- **Per-key limit:** 50 requests per 15 minutes
- **Burst size:** 10 requests
- **Key:** `inspector_{apiKeyId}` or `inspector_ip_{ip}` (fallback)

### Use Cases

- MCP Inspector tool
- Custom integrations
- Testing and development
- Read-only access (default)
- Write access (with `mcp:full` scope)

---

## User Isolation

<Warning>
**Critical:** All MCP operations are scoped to the authenticated user. There is zero cross-user data access.
</Warning>

### How It Works

1. **OAuth:** `userId` extracted from JWT token claims
2. **API Key:** `userId` from API key record (`apiKey.userId`)
3. **Context:** All tool executions receive `context.userId`
4. **Database Queries:** All queries include `WHERE userId = context.userId`

---

## Error Responses

### Invalid Token

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": 401,
    "message": "Unauthorized",
    "data": {
      "errorType": "INVALID_TOKEN",
      "message": "Invalid or expired authentication token"
    }
  }
}
```

### Missing/Invalid API Key

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": 401,
    "message": "Unauthorized",
    "data": {
      "errorType": "INVALID_API_KEY",
      "message": "API key not found or has been revoked"
    }
  }
}
```

### Insufficient Scope

```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "error": {
    "code": 403,
    "message": "Forbidden",
    "data": {
      "errorType": "INSUFFICIENT_SCOPE",
      "message": "API key does not have permission for this operation"
    }
  }
}
```

---

## Best Practices

<CardGroup cols={2}>
  <Card title="Store Keys Securely" icon="lock">
    Never commit API keys to version control. Use environment variables or secret management.
  </Card>
  
  <Card title="Use Minimal Scopes" icon="shield">
    Grant only the minimum permissions needed. Use `mcp:read` for read-only access.
  </Card>
  
  <Card title="Rotate Keys Regularly" icon="refresh">
    Rotate API keys periodically (every 90 days recommended).
  </Card>
  
  <Card title="Use HTTPS Only" icon="lock">
    Always use HTTPS for API key transmission. Never send keys over HTTP.
  </Card>
</CardGroup>
